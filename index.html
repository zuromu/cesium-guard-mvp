<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Shrimp Contamination — Smart Monitor (Zones)</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React 18 -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

  <!-- Babel (dev) -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Leaflet + heat plugin -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    html,body,#root { height:100%; }
    body { background: #071024; color: #E6EEF8; font-family: Inter, system-ui, Arial; }
    .leaflet-container { border-radius: 12px; }
    .pulse {
      border-radius:50%;
      animation: pulse 1.8s infinite;
      box-shadow: 0 0 0 6px rgba(255,0,0,0.15);
    }
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(255,0,0,0.15); }
      70% { box-shadow: 0 0 0 12px rgba(255,0,0,0); }
      100% { box-shadow: 0 0 0 0 rgba(255,0,0,0); }
    }
  </style>
</head>
<body>
  <div id="root" class="h-full"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;
    const API = '/api';

    function colorForSeverity(sev) {
      if (sev === 'Critical') return '#7f1d1d';
      if (sev === 'High') return '#dc2626';
      if (sev === 'Medium') return '#f59e0b';
      return '#16a34a';
    }

    function App() {
      const [farms, setFarms] = useState([]);
      const [zones, setZones] = useState([]);
      const [stats, setStats] = useState({});
      const [selectedFarm, setSelectedFarm] = useState(null);
      const [newSample, setNewSample] = useState({ farm_id:'', value:'', inspector:'' });
      const mapRef = useRef(null);
      const markersRef = useRef([]);
      const heatRef = useRef(null);
      const zoneLayersRef = useRef([]);
      const timeseriesChartRef = useRef(null);

      // load all
      async function loadAll() {
        try {
          const [fRes, zRes, sRes, hRes] = await Promise.all([
            fetch(API + '/f

arms').then(r=>r.json()),
            fetch(API + '/zones').then(r=>r.json()),
            fetch(API + '/stats').then(r=>r.json()),
            fetch(API + '/heatmap').then(r=>r.json())
          ]);
          setFarms(fRes);
          setZones(zRes);
          setStats(sRes);

          // heat points
          if (heatRef.current) {
            heatRef.current.setLatLngs(hRes.points.map(p => [p[0], p[1], p[2]]));
          }
        } catch (e) {
          console.error(e);
        }
      }

      useEffect(() => {
        // init map
        if (mapRef.current) return;
        const map = L.map('map', { zoomControl: true }).setView([-2.5, 118], 5);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        // heat
        const heat = L.heatLayer([], { radius: 25, blur: 35, maxZoom: 12 }).addTo(map);
        heatRef.current = heat;

        mapRef.current = map;
        loadAll();

        // poll every 12s for live feel
        const iv = setInterval(loadAll, 12000);
        return () => clearInterval(iv);
      }, []);

      // update markers when farms change
      useEffect(() => {
        const map = mapRef.current; if (!map) return;
        // remove existing markers
        markersRef.current.forEach(m => map.removeLayer(m)); markersRef.current = [];
        farms.forEach(f => {
          const el = document.createElement('div');
          el.style.width = '14px';
          el.style.height = '14px';
          el.style.borderRadius = '50%';
          el.style.border = '2px solid white';
          // color by status
          let bg = '#16a34a';
          if (f.status === 'High') bg = '#f97316';
          if (f.status === 'Critical') bg = '#ef4444';
          if (f.status === 'Medium') bg = '#f59e0b';
          el.style.background = bg;
          if (f.status === 'Critical') el.classList.add('pulse');
          const icon = L.divIcon({ html: el.outerHTML, className:'', iconSize:[24,24], iconAnchor:[12,12] });
          const m = L.marker([f.lat, f.lng], { icon }).addTo(map);
          m.bindPopup(`<strong>${f.name}</strong><br/>${f.location}<br/><b>${f.value} ppb</b><br/>Status: ${f.status}<br/>Last: ${new Date(f.lastUpdate).toLocaleString()}<hr/><div style="max-height:140px;overflow:auto;">History:<br/>${(f.history||[]).slice().reverse().map(h=>`${new Date(h.time).toLocaleString()} — ${h.inspector}: ${h.value} ppb`).join('<br/>')}</div>`);
          markersRef.current.push(m);
        });
      }, [farms]);

      // update zones (circles)
      useEffect(() => {
        const map = mapRef.current; if (!map) return;
        zoneLayersRef.current.forEach(l => map.removeLayer(l)); zoneLayersRef.current = [];
        zones.forEach(z => {
          const color = colorForSeverity(z.severity || z.severity);
          // draw circle using center and radius_m
          const circle = L.circle(z.center, {
            color: color,
            fillColor: color,
            fillOpacity: 0.12,
            radius: z.radius_m || 40000,
            weight: 1.5
          }).addTo(map);
          circle.bindPopup(`<strong>${z.name}</strong><br/>Avg: ${z.avg} ppb<br/>Severity: ${z.severity}<br/>Farms: ${z.count_farms}<br/>Top: ${z.top_farm ? (z.top_farm.name + ' (' + z.top_farm.value + ' ppb)') : '-'}`);
          zoneLayersRef.current.push(circle);
        });
      }, [zones]);

      // draw timeseries chart
      useEffect(() => {
        const ctx = document.getElementById('timeseries');
        if (!ctx) return;
        const tdata = stats.timeseries || [];
        const labels = tdata.map(p => p.t);
        const vals = tdata.map(p => p.v);
        if (timeseriesChartRef.current) {
          timeseriesChartRef.current.data.labels = labels;
          timeseriesChartRef.current.data.datasets[0].data = vals;
          timeseriesChartRef.current.update();
        } else {
          timeseriesChartRef.current = new Chart(ctx, {
            type: 'line',
            data: { labels, datasets: [{ label:'Avg ppb', data: vals, borderColor:'#60a5fa', backgroundColor:'rgba(96,165,250,0.12)', tension:0.25, pointRadius:2 }]},
            options: { plugins:{ legend:{display:false} }, scales:{ x:{ ticks:{ color:'#cbd5e1' } }, y:{ ticks:{ color:'#cbd5e1' } } } }
          });
        }
      }, [stats]);

      async function submitSample(e) {
        e && e.preventDefault();
        if (!newSample.farm_id || newSample.value==='') { alert('Complete form'); return; }
        const res = await fetch(API + '/samples', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ farm_id: Number(newSample.farm_id), value: Number(newSample.value), inspector: newSample.inspector || 'field' })});
        const j = await res.json();
        if (j.success) {
          setNewSample({ farm_id:'', value:'', inspector:'' });
          await loadAll();
          alert('Sample added');
        } else {
          alert('Error: ' + (j.error || j.message || 'unknown'));
        }
      }

      async function simulate() {
        await fetch(API + '/simulate');
        await loadAll();
      }

      // top hotspots
      const top = (stats.top_hotspots || []).slice(0,5);

      return (
        <div className="min-h-screen flex flex-col">
          {/* header */}
          <header className="bg-slate-900/70 px-6 py-3 border-b border-slate-700">
            <div className="max-w-[1400px] mx-auto flex justify-between items-center">
              <div className="flex items-center gap-3">
                <div className="w-12 h-12 bg-gradient-to-br from-purple-600 to-pink-500 rounded-lg flex items-center justify-center">
                  <svg width="26" height="26" viewBox="0 0 24 24" fill="none"><path d="M3 12c0 5 4 9 9 9s9-4 9-9" stroke="#fff" strokeWidth="1.2"/></svg>
                </div>
                <div>
                  <h1 className="text-lg font-semibold">Shrimp Contamination — Smart Monitor</h1>
                  <div className="text-xs text-slate-400">Live zones, hotspots & actionable stats</div>
                </div>
              </div>
              <div className="flex items-center gap-3">
                <button onClick={loadAll} className="px-3 py-2 bg-slate-800 rounded">Refresh</button>
                <button onClick={simulate} className="px-3 py-2 bg-orange-500 rounded">Simulate</button>
                <div className="text-xs text-slate-400 text-right">
                  <div>Last checked</div>
                  <div className="font-semibold">{new Date().toLocaleString()}</div>
                </div>
              </div>
            </div>
          </header>

          {/* main */}
          <main className="flex-1 overflow-auto">
            <div className="max-w-[1400px] mx-auto px-6 py-6 grid grid-cols-12 gap-6">
              {/* left */}
              <aside className="col-span-4 space-y-6">
                <div className="bg-slate-800/50 rounded-2xl p-4 border border-slate-700">
                  <h3 className="text-sm text-slate-300 mb-2">Dashboard Stats</h3>
                  <div className="grid grid-cols-3 gap-3 mb-3">
                    <div className="bg-slate-900 p-3 rounded text-center">
                      <div className="text-xs text-slate-400">Farms</div>
                      <div className="text-lg font-bold">{stats.total || 0}</div>
                    </div>
                    <div className="bg-slate-900 p-3 rounded text-center">
                      <div className="text-xs text-slate-400">Avg (ppb)</div>
                      <div className="text-lg font-bold">{stats.avg || 0}</div>
                    </div>
                    <div className="bg-slate-900 p-3 rounded text-center">
                      <div className="text-xs text-slate-400">Max</div>
                      <div className="text-lg font-bold">{stats.max || 0}</div>
                    </div>
                  </div>
                  <div className="text-xs text-slate-400">
                    <div>Critical: <span className="font-semibold text-red-400">{stats.high||0}</span></div>
                    <div>Medium: <span className="font-semibold text-orange-400">{stats.medium||0}</span></div>
                    <div>Safe: <span className="font-semibold text-green-400">{stats.safe||0}</span></div>
                  </div>
                </div>

                <div className="bg-slate-800/50 rounded-2xl p-4 border border-slate-700">
                  <h4 className="text-sm text-slate-300 mb-2">Top hotspots</h4>
                  <ol className="list-decimal pl-4 text-sm">
                    {top.length ? top.map(h => <li key={h.id}><strong>{h.name}</strong> — {h.value} ppb</li>) : <li className="text-slate-400">No data</li>}
                  </ol>
                </div>

                <div className="bg-slate-800/50 rounded-2xl p-4 border border-slate-700">
                  <h4 className="text-sm text-slate-300 mb-2">Add sample</h4>
                  <form onSubmit={submitSample} className="space-y-2">
                    <select value={newSample.farm_id} onChange={e => setNewSample({...newSample, farm_id: e.target.value})} className="w-full p-2 bg-slate-900 rounded text-sm">
                      <option value=''>-- pilih farm --</option>
                      {farms.map(f => <option key={f.id} value={f.id}>{f.name} ({f.location})</option>)}
                    </select>
                    <input type="number" step="0.1" value={newSample.value} onChange={e => setNewSample({...newSample, value: e.target.value})} placeholder="Value (ppb)" className="w-full p-2 bg-slate-900 rounded text-sm"/>
                    <input type="text" value={newSample.inspector} onChange={e => setNewSample({...newSample, inspector: e.target.value})} placeholder="Inspector" className="w-full p-2 bg-slate-900 rounded text-sm"/>
                    <div className="flex gap-2">
                      <button type="submit" className="flex-1 bg-blue-600 py-2 rounded">Submit</button>
                      <button type="button" onClick={() => setNewSample({farm_id:'',value:'',inspector:''})} className="px-3 bg-slate-700 rounded">Reset</button>
                    </div>
                  </form>
                </div>

                <div className="bg-slate-800/50 rounded-2xl p-4 border border-slate-700">
                  <h4 className="text-sm text-slate-300 mb-2">Recent trips</h4>
                  <div className="text-xs text-slate-400">
                    {(stats.recent_trips || []).map((t,i) => <div key={i} className="mb-2"><b>{t.location}</b><div className="text-slate-400 text-xs">{t.time}</div></div>)}
                  </div>
                </div>
              </aside>

              {/* main */}
              <section className="col-span-8 space-y-6">
                <div className="bg-slate-800/50 rounded-2xl p-4 border border-slate-700">
                  <div className="flex items-center justify-between mb-3">
                    <h3 className="text-lg font-semibold">Indonesia — Live Contamination Map</h3>
                    <div className="flex gap-2">
                      <div className="px-2 py-1 rounded bg-red-600 text-sm">Critical</div>
                      <div className="px-2 py-1 rounded bg-orange-500 text-sm">High</div>
                      <div className="px-2 py-1 rounded bg-yellow-500 text-sm">Medium</div>
                      <div className="px-2 py-1 rounded bg-green-600 text-sm">Safe</div>
                    </div>
                  </div>
                  <div id="map" style={{height: 560}} className="rounded-lg overflow-hidden"></div>
                </div>

                <div className="bg-slate-800/50 rounded-2xl p-4 border border-slate-700 grid grid-cols-3 gap-4">
                  <div className="col-span-2">
                    <h4 className="text-sm text-slate-300 mb-2">Average contamination — trend</h4>
                    <canvas id="timeseries" height="120"></canvas>
                  </div>
                  <div>
                    <h4 className="text-sm text-slate-300 mb-2">Zones summary</h4>
                    <div className="space-y-2 text-sm">
                      {zones.map(z => (
                        <div key={z.id} className="flex items-center justify-between">
                          <div>
                            <div className="font-semibold">{z.name}</div>
                            <div className="text-xs text-slate-400">Avg {z.avg} ppb — {z.count_farms} farms</div>
                          </div>
                          <div style={{width:14, height:14, background: colorForSeverity(z.severity), borderRadius:7}} />
                        </div>
                      ))}
                    </div>
                  </div>
                </div>
              </section>
            </div>
          </main>
        </div>
      );
    }

    // mount
    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
